<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriTrace - POC Enterprise (Responsive)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#1F3A5F', secondary: '#2E5E8A', bglight: '#F4F6F8' } }
            }
        }
    </script>
    <style>
        .view-section {
            display: none;
            animation: fadeIn 0.2s ease-in-out;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-bglight flex h-screen overflow-hidden text-gray-800 font-sans relative">

    <div id="toast"
        class="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 z-50 flex items-center">
        <i class="fas fa-check-circle mr-2"></i> <span id="toast-msg">Acción exitosa</span>
    </div>

    <div id="crud-modal"
        class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-opacity p-2 sm:p-4">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[95vh] sm:max-h-[90vh]">
            <div
                class="px-4 sm:px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 shrink-0">
                <h3 id="modal-title" class="text-base sm:text-lg font-bold text-gray-800">Formulario</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 transition"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <form id="crud-form" onsubmit="saveData(event)"
                class="overflow-y-auto p-4 sm:p-6 space-y-4 sm:space-y-6 flex-1">
                <input type="hidden" id="modal-module">
                <input type="hidden" id="modal-id">

                <h4 class="font-semibold text-gray-700 border-b pb-2 mb-2 sm:mb-4 text-sm sm:text-base">Datos
                    Principales</h4>
                <div id="modal-fields" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4"></div>

                <div id="modal-items-container" class="hidden border-t border-gray-200 pt-4 mt-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 gap-2">
                        <h4 class="font-semibold text-gray-700 text-sm sm:text-base">Detalle / Ítems</h4>
                        <button type="button" onclick="addDetailRow()"
                            class="w-full sm:w-auto px-3 py-1.5 bg-green-100 text-green-700 hover:bg-green-200 rounded text-sm font-medium transition"><i
                                class="fas fa-plus mr-1"></i> Agregar Línea</button>
                    </div>
                    <div class="bg-gray-50 rounded border border-gray-200 overflow-hidden overflow-x-auto">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-100 text-gray-600 border-b" id="items-thead"></thead>
                            <tbody id="items-tbody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </form>
            <div
                class="px-4 sm:px-6 py-4 border-t border-gray-100 bg-gray-50 flex flex-col sm:flex-row justify-end gap-2 sm:gap-3 shrink-0">
                <button type="button" onclick="closeModal()"
                    class="w-full sm:w-auto px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-100 transition font-medium">Cancelar</button>
                <button type="submit" form="crud-form"
                    class="w-full sm:w-auto px-4 py-2 bg-primary text-white rounded shadow hover:bg-secondary transition font-medium">Guardar
                    Registro</button>
            </div>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-slate-900 bg-opacity-50 z-20 hidden md:hidden backdrop-blur-sm transition-opacity">
    </div>

    <aside id="sidebar"
        class="fixed md:static inset-y-0 left-0 w-64 bg-primary text-white flex flex-col shadow-2xl md:shadow-xl z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out overflow-y-auto">
        <div
            class="h-16 flex items-center justify-between px-6 font-bold text-xl border-b border-secondary/50 shrink-0">
            <span><i class="fas fa-shield-alt text-blue-400 mr-2"></i> NutriTrace</span>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-300 hover:text-white"><i
                    class="fas fa-times"></i></button>
        </div>
        <div class="px-6 py-3 text-xs text-blue-300 font-semibold uppercase tracking-wider mt-2">Operación</div>
        <nav class="px-4 space-y-1">
            <button onclick="navigate('dashboard', this)"
                class="w-full flex items-center px-4 py-3 bg-secondary rounded-lg text-sm font-medium menu-btn active text-white"><i
                    class="fas fa-chart-line w-6 text-left opacity-80"></i> Dashboard</button>
            <button onclick="navigate('recepcion', this)"
                class="w-full flex items-center px-4 py-3 hover:bg-secondary/50 rounded-lg text-sm font-medium text-gray-300 menu-btn"><i
                    class="fas fa-truck-loading w-6 text-left opacity-80"></i> Recepciones</button>
            <button onclick="navigate('elaboracion', this)"
                class="w-full flex items-center px-4 py-3 hover:bg-secondary/50 rounded-lg text-sm font-medium text-gray-300 menu-btn"><i
                    class="fas fa-boxes w-6 text-left opacity-80"></i> Lotes de Prod.</button>
            <button onclick="navigate('despacho', this)"
                class="w-full flex items-center px-4 py-3 hover:bg-secondary/50 rounded-lg text-sm font-medium text-gray-300 menu-btn"><i
                    class="fas fa-shipping-fast w-6 text-left opacity-80"></i> Despachos</button>
        </nav>
        <div
            class="px-6 py-3 text-xs text-blue-300 font-semibold uppercase tracking-wider mt-4 border-t border-secondary/30 pt-4">
            Administración</div>
        <nav class="px-4 space-y-1 flex-1 mb-4">
            <button onclick="navigate('productos', this)"
                class="w-full flex items-center px-4 py-3 hover:bg-secondary/50 rounded-lg text-sm font-medium text-gray-300 menu-btn"><i
                    class="fas fa-box-open w-6 text-left opacity-80"></i> Catálogo Productos</button>
            <button onclick="navigate('materias', this)"
                class="w-full flex items-center px-4 py-3 hover:bg-secondary/50 rounded-lg text-sm font-medium text-gray-300 menu-btn"><i
                    class="fas fa-seedling w-6 text-left opacity-80"></i> Diccionario M.P.</button>
            <button onclick="navigate('proveedores', this)"
                class="w-full flex items-center px-4 py-3 hover:bg-secondary/50 rounded-lg text-sm font-medium text-gray-300 menu-btn"><i
                    class="fas fa-handshake w-6 text-left opacity-80"></i> Proveedores</button>
            <button onclick="navigate('clientes', this)"
                class="w-full flex items-center px-4 py-3 hover:bg-secondary/50 rounded-lg text-sm font-medium text-gray-300 menu-btn"><i
                    class="fas fa-users w-6 text-left opacity-80"></i> Clientes</button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden w-full">

        <header class="h-16 bg-white shadow-sm flex items-center justify-between px-4 sm:px-8 z-10 shrink-0">
            <div class="flex items-center">
                <button onclick="toggleSidebar()"
                    class="md:hidden mr-4 text-gray-500 hover:text-primary focus:outline-none transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="text-lg sm:text-xl font-semibold text-gray-800 truncate">Dashboard Operativo
                </h2>
            </div>
            <div class="flex items-center space-x-2">
                <span
                    class="px-2 py-1 sm:px-3 sm:py-1 bg-blue-100 text-blue-800 text-[10px] sm:text-xs font-bold rounded border border-blue-200 hidden sm:inline-block">
                    <i class="fas fa-mobile-alt mr-1"></i> Mobile Ready
                </span>
                <div
                    class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-xs">
                    OP</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 sm:p-8 relative" id="main-views-container">
        </div>
    </main>

    <script>
        // ==========================================
        // LÓGICA RESPONSIVE MÓVIL (MENÚ)
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // ==========================================
        // 1. BASE DE DATOS ESTRUCTURADA
        // ==========================================
        let db = {
            productos: [{ id: 1, codigo: 'PRD-001', nombre: 'Pan de Molde', categoria: 'Panificados' }],
            materias: [{ id: 1, nombre: 'Harina 000', tipo: 'Ingrediente', um: 'Kg', especificacion: 'Industrial', temp_obj: '25' }],
            proveedores: [{ id: 1, razon: 'Molinos del Sur S.A.', cuit: '30-71234567-8', direccion: 'Ruta 9 Km 50', telefono: '0341-155443322', email: 'ventas@molinos.com', rubro: 'Harinas' }],
            clientes: [{ id: 1, nombre: 'Supermercados El Sol', direccion: 'Av. Siempre Viva 123', telefono: '0342-4556677', email: 'compras@elsol.com', tipo: 'Mayorista' }],
            recepcion: [{ id: 1, remito: 'REM-102', fecha: '2026-02-19', proveedor_id: 1, proveedor_nombre: 'Molinos del Sur S.A.', detalles: [{ materia: 'Harina 000', lote: 'L-889', cant: 500, vencimiento: '2026-12-01' }] }],
            elaboracion: [{ id: 1, lote: 'LOTE-PAN-1', fecha: '2026-02-20', producto: 'Pan de Molde', estado: 'En Proceso', detalles: [{ mp_usada: 'L-889 (Harina)', cant: 200 }] }],
            despacho: [{ id: 1, orden: 'ORD-1001', fecha: '2026-02-21', transporte: 'Flete Propio', cliente: 'Supermercados El Sol', detalles: [{ lote_prod: 'LOTE-PAN-1', cant: 150 }] }]
        };

        // ==========================================
        // 2. CONFIGURACIÓN DE FILTROS POR MÓDULO
        // ==========================================
        const filterConfigs = {
            recepcion: [{ id: 'f_remito', label: 'Nº Remito', type: 'text' }, { id: 'f_proveedor', label: 'Proveedor', type: 'selectDb', source: 'proveedores', textKey: 'razon', valKey: 'id' }, { id: 'f_desde', label: 'Desde', type: 'date' }, { id: 'f_hasta', label: 'Hasta', type: 'date' }],
            elaboracion: [{ id: 'f_lote', label: 'Nº Lote', type: 'text' }, { id: 'f_producto', label: 'Producto', type: 'selectDb', source: 'productos', textKey: 'nombre', valKey: 'nombre' }, { id: 'f_estado', label: 'Estado', type: 'select', options: ['En Proceso', 'Finalizado', 'Anulado'] }, { id: 'f_desde', label: 'Desde', type: 'date' }, { id: 'f_hasta', label: 'Hasta', type: 'date' }],
            despacho: [{ id: 'f_orden', label: 'Nº Orden', type: 'text' }, { id: 'f_cliente', label: 'Cliente', type: 'selectDb', source: 'clientes', textKey: 'nombre', valKey: 'nombre' }, { id: 'f_desde', label: 'Desde', type: 'date' }, { id: 'f_hasta', label: 'Hasta', type: 'date' }],
            productos: [{ id: 'f_codigo', label: 'Código', type: 'text' }, { id: 'f_nombre', label: 'Nombre', type: 'text' }, { id: 'f_categoria', label: 'Categoría', type: 'select', options: ['Galletas', 'Panificados', 'Pastelería'] }],
            materias: [{ id: 'f_nombre', label: 'Nombre M.P.', type: 'text' }, { id: 'f_tipo', label: 'Tipo', type: 'select', options: ['Ingrediente', 'Empaque'] }],
            proveedores: [{ id: 'f_razon', label: 'Razón Social', type: 'text' }, { id: 'f_cuit', label: 'CUIT', type: 'text' }, { id: 'f_rubro', label: 'Rubro', type: 'text' }],
            clientes: [{ id: 'f_nombre', label: 'Razón Social', type: 'text' }, { id: 'f_tipo', label: 'Tipo', type: 'select', options: ['Mayorista', 'Minorista'] }]
        };

        // ==========================================
        // 3. GENERACIÓN ESTRATÉGICA DE VISTAS (LAYOUT)
        // ==========================================
        const viewDefinitions = {
            dashboard: { title: 'Dashboard Operativo', cols: [] },
            recepcion: { title: 'Gestión de Recepciones', cols: ['Fecha', 'Remito', 'Proveedor', 'Ítems'] },
            elaboracion: { title: 'Lotes de Producción', cols: ['Fecha', 'Lote', 'Producto', 'Estado', 'Consumo M.P.'] },
            despacho: { title: 'Despachos Registrados', cols: ['Fecha', 'Orden', 'Transporte', 'Cliente', 'Lotes Enviados'] },
            productos: { title: 'Catálogo de Productos', cols: ['Código', 'Nombre', 'Categoría'] },
            materias: { title: 'Diccionario de Insumos', cols: ['Nombre', 'Tipo', 'Especificación', 'U.M.'] },
            proveedores: { title: 'Padrón de Proveedores', cols: ['Razón Social', 'CUIT', 'Teléfono', 'Email', 'Rubro'] },
            clientes: { title: 'Cartera de Clientes', cols: ['Nombre', 'Teléfono', 'Email', 'Tipo'] }
        };

        function initViews() {
            const container = document.getElementById('main-views-container');
            container.innerHTML = '';

            for (let mod in viewDefinitions) {
                let def = viewDefinitions[mod];
                let viewHtml = `<div id="${mod}" class="view-section ${mod === 'dashboard' ? 'active' : ''}">`;

                if (mod === 'dashboard') {
                    viewHtml += `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
                        <div class="bg-white p-4 sm:p-5 rounded-xl shadow-sm border border-l-4 border-l-blue-500"><p class="text-xs sm:text-sm text-gray-500">Lotes Prod.</p><p id="kpi-lotes" class="text-2xl sm:text-3xl font-bold">0</p></div>
                        <div class="bg-white p-4 sm:p-5 rounded-xl shadow-sm border border-l-4 border-l-green-500"><p class="text-xs sm:text-sm text-gray-500">Recepciones</p><p id="kpi-recepciones" class="text-2xl sm:text-3xl font-bold">0</p></div>
                        <div class="bg-white p-4 sm:p-5 rounded-xl shadow-sm border border-l-4 border-l-purple-500"><p class="text-xs sm:text-sm text-gray-500">Clientes</p><p id="kpi-clientes" class="text-2xl sm:text-3xl font-bold">0</p></div>
                        <div class="bg-white p-4 sm:p-5 rounded-xl shadow-sm border border-l-4 border-l-yellow-500"><p class="text-xs sm:text-sm text-gray-500">Proveedores</p><p id="kpi-proveedores" class="text-2xl sm:text-3xl font-bold">0</p></div>
                    </div>`;
                } else {
                    viewHtml += `<h3 class="text-lg sm:text-2xl font-medium text-gray-700 mb-3 sm:mb-4 hidden md:block">${def.title}</h3>`;

                    let filtersHtml = '';
                    if (filterConfigs[mod]) {
                        filtersHtml = filterConfigs[mod].map(f => {
                            let input = `<input type="${f.type}" id="${mod}_${f.id}" class="w-full border border-gray-300 rounded px-2 sm:px-3 py-1.5 text-sm outline-none focus:ring-1 focus:ring-primary">`;
                            if (f.type === 'select') input = `<select id="${mod}_${f.id}" class="w-full border border-gray-300 rounded px-2 sm:px-3 py-1.5 text-sm bg-white"><option value="">Todos</option>${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
                            else if (f.type === 'selectDb') input = `<select id="${mod}_${f.id}" class="w-full border border-gray-300 rounded px-2 sm:px-3 py-1.5 text-sm bg-white"><option value="">Todos</option>${db[f.source].map(s => `<option value="${s[f.valKey]}">${s[f.textKey]}</option>`).join('')}</select>`;
                            return `<div><label class="block text-[10px] sm:text-xs font-semibold text-gray-500 mb-1">${f.label}</label>${input}</div>`;
                        }).join('');
                    }

                    // TOOLBAR 100% RESPONSIVE (Botones apilados en móvil, en línea en PC)
                    viewHtml += `
                    <div class="bg-white p-3 sm:p-4 rounded-lg shadow-sm border border-gray-200 mb-4 sm:mb-5">
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mb-4 items-end">
                            ${filtersHtml}
                        </div>
                        <div class="flex flex-col md:flex-row justify-between items-stretch md:items-center border-t border-gray-100 pt-4 mt-2 gap-3">
                            <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                <button onclick="exportar()" class="w-full sm:w-auto bg-slate-700 text-white px-4 py-2 rounded text-sm font-medium shadow hover:bg-slate-800 transition justify-center flex items-center"><i class="fas fa-file-export mr-2"></i>Exportar</button>
                                <button onclick="openModal('${mod}')" class="w-full sm:w-auto bg-primary text-white px-4 py-2 rounded text-sm font-medium shadow hover:bg-secondary transition justify-center flex items-center"><i class="fas fa-plus mr-2"></i>Nuevo</button>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto mt-2 md:mt-0">
                                <button onclick="limpiarFiltros('${mod}')" class="w-full sm:w-auto bg-gray-100 text-gray-600 border border-gray-300 px-4 py-2 rounded text-sm font-medium shadow-sm hover:bg-gray-200 transition justify-center flex items-center"><i class="fas fa-eraser mr-2"></i>Limpiar</button>
                                <button onclick="renderTable('${mod}')" class="w-full sm:w-auto bg-green-600 text-white px-6 py-2 rounded text-sm font-medium shadow hover:bg-green-700 transition justify-center flex items-center"><i class="fas fa-search mr-2"></i>Buscar</button>
                            </div>
                        </div>
                    </div>`;

                    let ths = def.cols.map(c => `<th class="px-3 sm:px-4 py-2 sm:py-3 font-semibold">${c}</th>`).join('') + `<th class="px-3 sm:px-4 py-2 sm:py-3 text-right font-semibold">Acciones</th>`;
                    viewHtml += `
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden flex flex-col">
                        <div class="overflow-x-auto w-full">
                            <table class="w-full text-left text-xs sm:text-sm whitespace-nowrap min-w-[600px]">
                                <thead class="bg-gray-50 text-gray-600 border-b"><tr>${ths}</tr></thead>
                                <tbody id="tbody-${mod}" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                        <div class="px-4 py-3 border-t border-gray-200 bg-gray-50 flex items-center justify-between mt-auto">
                            <span class="text-xs sm:text-sm text-gray-600">Mostrando <span id="pag-${mod}-end" class="font-bold">0</span> de <span id="pag-${mod}-total" class="font-bold">0</span></span>
                            <div class="flex space-x-1">
                                <button class="px-2 sm:px-3 py-1 border border-gray-300 rounded bg-white text-gray-400 cursor-not-allowed text-xs sm:text-sm">Anterior</button>
                                <button class="px-2 sm:px-3 py-1 border border-gray-300 rounded bg-white text-gray-400 cursor-not-allowed text-xs sm:text-sm">Siguiente</button>
                            </div>
                        </div>
                    </div>`;
                }
                viewHtml += `</div>`;
                container.innerHTML += viewHtml;
            }
        }

        // ==========================================
        // 4. LÓGICA DE TABLAS Y FILTRADO
        // ==========================================
        function getFilteredData(module) {
            let data = db[module];
            const filters = filterConfigs[module];
            if (!filters) return data;

            let fVals = {};
            filters.forEach(f => { fVals[f.id] = document.getElementById(`${module}_${f.id}`).value.toLowerCase(); });

            return data.filter(item => {
                let match = true;
                if (fVals.f_desde && item.fecha && item.fecha < fVals.f_desde) match = false;
                if (fVals.f_hasta && item.fecha && item.fecha > fVals.f_hasta) match = false;
                if (fVals.f_remito && !item.remito?.toLowerCase().includes(fVals.f_remito)) match = false;
                if (fVals.f_lote && !item.lote?.toLowerCase().includes(fVals.f_lote)) match = false;
                if (fVals.f_orden && !item.orden?.toLowerCase().includes(fVals.f_orden)) match = false;

                if (fVals.f_nombre && !item.nombre?.toLowerCase().includes(fVals.f_nombre)) match = false;
                if (fVals.f_razon && !item.razon?.toLowerCase().includes(fVals.f_razon)) match = false;
                if (fVals.f_cuit && !item.cuit?.toLowerCase().includes(fVals.f_cuit)) match = false;

                if (fVals.f_producto && document.getElementById(`${module}_f_producto`).value !== item.producto) match = false;
                if (fVals.f_cliente && document.getElementById(`${module}_f_cliente`).value !== item.cliente) match = false;
                if (fVals.f_proveedor && document.getElementById(`${module}_f_proveedor`).value != item.proveedor_id) match = false;
                if (fVals.f_estado && document.getElementById(`${module}_f_estado`).value !== item.estado) match = false;

                return match;
            });
        }

        function limpiarFiltros(module) {
            filterConfigs[module].forEach(f => document.getElementById(`${module}_${f.id}`).value = '');
            renderTable(module);
        }

        function renderTable(module) {
            if (module === 'dashboard') {
                document.getElementById('kpi-lotes').innerText = db.elaboracion.length;
                document.getElementById('kpi-recepciones').innerText = db.recepcion.length;
                document.getElementById('kpi-clientes').innerText = db.clientes.length;
                document.getElementById('kpi-proveedores').innerText = db.proveedores.length;
                return;
            }

            const tbody = document.getElementById(`tbody-${module}`);
            if (!tbody) return;
            const data = getFilteredData(module);
            tbody.innerHTML = '';
            document.getElementById(`pag-${module}-end`).innerText = data.length;
            document.getElementById(`pag-${module}-total`).innerText = data.length;

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="px-4 py-6 text-center text-gray-500 italic">No hay resultados.</td></tr>`;
                return;
            }

            data.forEach(item => {
                let tr = document.createElement('tr'); tr.className = 'hover:bg-gray-50 transition-colors';
                let html = '';

                let rowVals = [];
                if (module === 'productos') rowVals = [item.codigo, item.nombre, item.categoria];
                if (module === 'materias') rowVals = [item.nombre, item.tipo, item.especificacion, item.um];
                if (module === 'proveedores') rowVals = [item.razon, item.cuit, item.telefono, item.email, item.rubro];
                if (module === 'clientes') rowVals = [item.nombre, item.telefono, item.email, item.tipo];
                if (module === 'recepcion') rowVals = [item.fecha, item.remito, item.proveedor_nombre, item.detalles];
                if (module === 'elaboracion') rowVals = [item.fecha, item.lote, item.producto, item.estado, item.detalles];
                if (module === 'despacho') rowVals = [item.fecha, item.orden, item.transporte, item.cliente, item.detalles];

                rowVals.forEach(val => {
                    if (val === 'En Proceso') val = `<span class="bg-yellow-100 text-yellow-800 text-[10px] sm:text-xs px-2 py-1 rounded font-bold">En Proceso</span>`;
                    else if (val === 'Finalizado' || val === 'Enviado') val = `<span class="bg-green-100 text-green-800 text-[10px] sm:text-xs px-2 py-1 rounded font-bold">${val}</span>`;
                    else if (Array.isArray(val)) {
                        val = val.map(d => `<span class="bg-indigo-50 text-indigo-800 text-[10px] sm:text-xs px-2 py-1 rounded border border-indigo-200 inline-block m-0.5">${d.materia || d.mp_usada || d.lote_prod}: <b>${d.cant}</b></span>`).join('');
                    }
                    html += `<td class="px-3 sm:px-4 py-2 sm:py-3">${val || '-'}</td>`;
                });

                html += `<td class="px-3 sm:px-4 py-2 sm:py-3 text-right">
                    <button onclick="openModal('${module}', ${item.id})" class="text-blue-500 hover:text-blue-700 transition mx-1 sm:mx-2" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                    <button onclick="deleteItem('${module}', ${item.id})" class="text-red-400 hover:text-red-600 transition mx-1 sm:mx-2" title="Eliminar"><i class="fas fa-trash"></i></button>
                </td>`;
                tr.innerHTML = html; tbody.appendChild(tr);
            });
        }

        // ==========================================
        // 5. ESQUEMAS DE FORMULARIO Y LÓGICA
        // ==========================================
        const schemas = {
            productos: { f: [{ n: 'codigo', l: 'Código' }, { n: 'nombre', l: 'Nombre' }, { n: 'categoria', l: 'Categoría', t: 'select', o: ['Galletas', 'Panificados', 'Pastelería'] }] },
            materias: { f: [{ n: 'nombre', l: 'Nombre de M.P.' }, { n: 'tipo', l: 'Tipo', t: 'select', o: ['Ingrediente', 'Empaque', 'Aditivo'] }, { n: 'especificacion', l: 'Especificación Técnica' }, { n: 'um', l: 'Unidad Medida', t: 'select', o: ['Kg', 'Lts', 'Un'] }, { n: 'temp_obj', l: 'Temp. Objetiva (ºC)', t: 'number' }] },
            proveedores: { f: [{ n: 'razon', l: 'Razón Social' }, { n: 'cuit', l: 'CUIT' }, { n: 'direccion', l: 'Dirección Físico' }, { n: 'telefono', l: 'Teléfono' }, { n: 'email', l: 'Correo Electrónico' }, { n: 'rubro', l: 'Rubro' }] },
            clientes: { f: [{ n: 'nombre', l: 'Razón Social / Nombre' }, { n: 'direccion', l: 'Dirección' }, { n: 'telefono', l: 'Teléfono' }, { n: 'email', l: 'Email' }, { n: 'descripcion', l: 'Descripción/Observación' }, { n: 'tipo', l: 'Tipo', t: 'select', o: ['Mayorista', 'Minorista'] }] },
            recepcion: { f: [{ n: 'fecha', l: 'Fecha Recepción', t: 'date' }, { n: 'remito', l: 'Nº Remito' }, { n: 'proveedor_id', l: 'Proveedor', t: 'selectDb', s: 'proveedores', k: 'id', l2: 'razon' }], hasItems: true, cols: [{ n: 'materia', l: 'M.P.' }, { n: 'lote', l: 'Lote Empaque' }, { n: 'vencimiento', l: 'Vto', t: 'date' }, { n: 'cant', l: 'Cantidad' }] },
            elaboracion: { f: [{ n: 'fecha', l: 'Fecha Elaboración', t: 'date' }, { n: 'lote', l: 'Nº Lote Prod.' }, { n: 'producto', l: 'Producto', t: 'selectDb', s: 'productos', k: 'nombre', l2: 'nombre' }, { n: 'estado', l: 'Estado', t: 'select', o: ['En Proceso', 'Finalizado', 'Anulado'] }], hasItems: true, cols: [{ n: 'mp_usada', l: 'Lote M.P. Usada' }, { n: 'cant', l: 'Cant. Consumida' }] },
            despacho: { f: [{ n: 'fecha', l: 'Fecha Despacho', t: 'date' }, { n: 'orden', l: 'Orden de Compra' }, { n: 'transporte', l: 'Transporte' }, { n: 'cliente', l: 'Cliente Destino', t: 'selectDb', s: 'clientes', k: 'nombre', l2: 'nombre' }], hasItems: true, cols: [{ n: 'lote_prod', l: 'Lote Enviado' }, { n: 'cant', l: 'Cantidad' }] }
        };

        function openModal(module, id = null) {
            document.getElementById('modal-module').value = module;
            document.getElementById('modal-id').value = id || '';
            document.getElementById('modal-title').innerText = id ? `Editar - ${module.toUpperCase()}` : `Nuevo - ${module.toUpperCase()}`;

            const sch = schemas[module];
            const fc = document.getElementById('modal-fields');
            fc.innerHTML = '';

            let itemData = id ? db[module].find(x => x.id === id) : null;

            sch.f.forEach(f => {
                let val = itemData && itemData[f.n] ? itemData[f.n] : '';
                let inp = `<input type="${f.t || 'text'}" name="${f.n}" value="${val}" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-primary outline-none">`;

                if (f.t === 'select') inp = `<select name="${f.n}" class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-white outline-none focus:ring-1 focus:ring-primary">${f.o.map(o => `<option value="${o}" ${val === o ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
                if (f.t === 'selectDb') inp = `<select name="${f.n}" class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-white outline-none focus:ring-1 focus:ring-primary">${db[f.s].map(x => `<option value="${x[f.k]}" ${val == x[f.k] ? 'selected' : ''}>${x[f.l2]}</option>`).join('')}</select>`;
                fc.innerHTML += `<div><label class="block text-xs font-semibold text-gray-600 mb-1">${f.l}</label>${inp}</div>`;
            });

            const ic = document.getElementById('modal-items-container');
            const tbody = document.getElementById('items-tbody');
            if (sch.hasItems) {
                ic.classList.remove('hidden');
                document.getElementById('items-thead').innerHTML = `<tr>${sch.cols.map(c => `<th class="px-2 sm:px-4 py-2 font-medium">${c.l}</th>`).join('')}<th class="px-2 sm:px-4 py-2 text-right"></th></tr>`;
                tbody.innerHTML = '';
                if (itemData && itemData.detalles) itemData.detalles.forEach(d => addDetailRow(d));
                else addDetailRow();
            } else ic.classList.add('hidden');

            document.getElementById('crud-modal').classList.remove('hidden');
        }

        function addDetailRow(rowData = {}) {
            const mod = document.getElementById('modal-module').value;
            const tr = document.createElement('tr');
            let html = schemas[mod].cols.map(c => `<td class="px-1 sm:px-2 py-1.5"><input type="${c.t || 'text'}" name="item_${c.n}[]" value="${rowData[c.n] || ''}" class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs sm:text-sm outline-none focus:border-primary min-w-[80px]"></td>`).join('');
            html += `<td class="px-1 sm:px-2 py-1.5 text-right"><button type="button" onclick="this.closest('tr').remove()" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-times"></i></button></td>`;
            tr.innerHTML = html; document.getElementById('items-tbody').appendChild(tr);
        }

        function closeModal() { document.getElementById('crud-modal').classList.add('hidden'); }

        function saveData(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const mod = document.getElementById('modal-module').value;
            const idStr = document.getElementById('modal-id').value;

            let item = {};
            schemas[mod].f.forEach(f => {
                item[f.n] = fd.get(f.n);
                if (f.n === 'proveedor_id') item.proveedor_nombre = db.proveedores.find(x => x.id == item[f.n])?.razon;
            });

            if (schemas[mod].hasItems) {
                item.detalles = [];
                const cNames = schemas[mod].cols.map(c => c.n);
                const len = fd.getAll(`item_${cNames[0]}[]`).length;
                for (let i = 0; i < len; i++) { let d = {}; cNames.forEach(c => d[c] = fd.getAll(`item_${c}[]`)[i]); item.detalles.push(d); }
            }

            if (idStr) {
                let idNum = parseInt(idStr); let index = db[mod].findIndex(x => x.id === idNum);
                item.id = idNum; db[mod][index] = item; showToast('Actualizado');
            } else {
                item.id = Date.now(); db[mod].push(item); showToast('Creado');
            }
            closeModal(); renderTable(mod);
        }

        function deleteItem(module, id) {
            if (confirm('¿Eliminar registro permanentemente?')) { db[module] = db[module].filter(x => x.id !== id); renderTable(module); showToast('Eliminado'); }
        }

        function exportar() { showToast(`Generando archivo de exportación...`); }

        function navigate(viewId, btnElement) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            const titleEl = document.getElementById('page-title');
            if (titleEl && viewDefinitions[viewId]) titleEl.innerText = viewDefinitions[viewId].title;

            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('bg-secondary', 'text-white'); btn.classList.add('text-gray-300');
            });
            btnElement.classList.add('bg-secondary', 'text-white'); btnElement.classList.remove('text-gray-300');

            // Si es pantalla de celular y el menú está abierto, cerrarlo al navegar
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('-translate-x-full')) toggleSidebar();
            }
            renderTable(viewId);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = message;
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-x-full', 'opacity-0'), 3000);
        }

        // INICIALIZACIÓN
        initViews();
        for (let mod in viewDefinitions) { renderTable(mod); }
    </script>
</body>

</html>
